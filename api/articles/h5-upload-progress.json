{"title":"html5上传进度实现","slug":"h5-upload-progress","date":"2015-09-02T08:26:13.000Z","updated":"2016-11-12T19:13:08.458Z","comments":true,"path":"api/articles/h5-upload-progress.json","excerpt":"<p>博客一个月没更新了，着实是有点忙。<br>目前公司新版上线也到最后一波了，部分人员转战了一个新的APP产品的开发。<br>主体还是原生APP，也会有部分页面需要嵌入WEB页面，我也有幸作为唯一的前端人员加入了。</p><p>不过这次讲的内容跟这个APP没有半毛钱关系，是公司内部工作系统的一个扫码上传功能。<br>好吧，我参与的确实有点多！</p><p>要实现实时的进度展示，需要以下几个关键：</p><ol><li>异步上传</li><li>文件总大小</li><li>文件已上传大小</li></ol>","content":"<p>博客一个月没更新了，着实是有点忙。<br>目前公司新版上线也到最后一波了，部分人员转战了一个新的APP产品的开发。<br>主体还是原生APP，也会有部分页面需要嵌入WEB页面，我也有幸作为唯一的前端人员加入了。</p><p>不过这次讲的内容跟这个APP没有半毛钱关系，是公司内部工作系统的一个扫码上传功能。<br>好吧，我参与的确实有点多！</p><p>要实现实时的进度展示，需要以下几个关键：</p><ol><li>异步上传</li><li>文件总大小</li><li>文件已上传大小</li></ol><a id=\"more\"></a><h2 id=\"基本HTML结构\"><a href=\"#基本HTML结构\" class=\"headerlink\" title=\"基本HTML结构\"></a>基本HTML结构</h2><figure class=\"highlight html\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"file\"</span> <span class=\"attr\">id</span>=<span class=\"string\">\"upload\"</span> <span class=\"attr\">accept</span>=<span class=\"string\">\"image/*\"</span> &gt;</span></div></pre></td></tr></table></figure><h2 id=\"异步上传\"><a href=\"#异步上传\" class=\"headerlink\" title=\"异步上传\"></a>异步上传</h2><p>XHR是必须的，此外还需要一个<code>FormData</code>对象。</p><p>FormData，译为表单数据，也就是一个保存表单数据的容器。<br>可以利用这个对象写入键值对的数据项，再用xhr发送到处理接口。</p><figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> data = <span class=\"keyword\">new</span> FormData();</div><div class=\"line\">data.append(<span class=\"string\">'id'</span>, <span class=\"number\">9527</span>);</div><div class=\"line\">data.append(<span class=\"string\">'name'</span>, <span class=\"string\">'张三'</span>);</div><div class=\"line\">data.append(<span class=\"string\">'sex'</span>, <span class=\"string\">'男'</span>);</div></pre></td></tr></table></figure><p>不仅可以像以上简单的添加值类型，文件类型也不例外。<br>这样就可以直接使用xhr的send方法发送到后端。</p><figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">document</span>.querySelector(<span class=\"string\">'#upload'</span>).addEventListener(<span class=\"string\">'change'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> file = <span class=\"keyword\">this</span>.files[<span class=\"number\">0</span>],</div><div class=\"line\">        data = <span class=\"keyword\">new</span> FormData();</div><div class=\"line\">        </div><div class=\"line\">    data.append(<span class=\"string\">'photo'</span>, file);</div><div class=\"line\">    </div><div class=\"line\">    <span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</div><div class=\"line\">    xhr.addEventListener(<span class=\"string\">'load'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">event</span>)</span>&#123;</div><div class=\"line\">        <span class=\"comment\">// Success or Error</span></div><div class=\"line\">    &#125;, <span class=\"literal\">false</span>);</div><div class=\"line\">    xhr.open(<span class=\"string\">'post'</span>, <span class=\"string\">'/doLoad'</span>);</div><div class=\"line\">    xhr.send(data);</div><div class=\"line\">    </div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure><h2 id=\"上传进度\"><a href=\"#上传进度\" class=\"headerlink\" title=\"上传进度\"></a>上传进度</h2><p>与FormData相对应的上传状态监听事件</p><figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><div class=\"line\">xhr.upload.addEventListener(<span class=\"string\">'progress'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">event</span>)</span>&#123;</div><div class=\"line\">    <span class=\"comment\">// do...</span></div><div class=\"line\">&#125;, <span class=\"literal\">false</span>);</div></pre></td></tr></table></figure><p>该事件可以通过event对象获取上传状态。</p><ol><li>event.loaded: 已上传大小</li><li>event.total: 文件总大小</li></ol><p>这样计算进度就不在话下了，具体实现也就不废话了，众大侠各展神通吧！</p>","categories":[],"tags":[{"name":"Html5","path":"api/tags/Html5.json"},{"name":"文件上传","path":"api/tags/文件上传.json"}]}