{"title":"图片上传本地预览jquery插件","slug":"jqplugin-uploadpreview","date":"2015-05-07T10:11:00.000Z","updated":"2016-08-15T13:28:56.417Z","comments":true,"path":"api/articles/jqplugin-uploadpreview.json","excerpt":"<blockquote>\n<p>网上找到的一段代码，经过一番测试修改，兼容了IE7+、火狐、谷歌。<br>  并且扩展了多尺寸预览功能，可完美搭配 <a href=\"http://code.ciaoca.com/jquery/jcrop/\">jquery.Jcrop</a> 插件进行图像裁剪。<br>","content":"<blockquote>\n<p>网上找到的一段代码，经过一番测试修改，兼容了IE7+、火狐、谷歌。<br>  并且扩展了多尺寸预览功能，可完美搭配 <a href=\"http://code.ciaoca.com/jquery/jcrop/\" target=\"_blank\" rel=\"external\">jquery.Jcrop</a> 插件进行图像裁剪。<br><a id=\"more\"></a></p>\n</blockquote>\n<h3 id=\"插件代码\"><a href=\"#插件代码\" class=\"headerlink\" title=\"插件代码\"></a>插件代码</h3><pre><code>(function($) {\n    jQuery.fn.extend({\n        uploadPreview: function(opts) {\n            opts = jQuery.extend({\n                width: null,    \n                height: null,\n                imgDiv: &quot;#imgDiv&quot;,  \n                anyTarget: null,    \n                maxSize: 300,       \n                imgType: [&quot;gif&quot;, &quot;jpeg&quot;, &quot;jpg&quot;, &quot;bmp&quot;, &quot;png&quot;],  \n                callback: function() { return false; }  \n            }, opts || {});\n\n            var _this = $(this);\n            var imgDiv = $(opts.imgDiv);\n            opts.width &amp;amp;&amp;amp; imgDiv.width(opts.width);\n            opts.height &amp;amp;&amp;amp; imgDiv.height(opts.height);\n\n            var isIE = navigator.appName == &apos;Microsoft Internet Explorer&apos;, \n                brVersion = navigator.appVersion, version;\n            isIE &amp;amp;&amp;amp; (version = brVersion.split(&apos;;&apos;)[1].replace(/MSIE[ ]/g,&apos;&apos;).replace(&apos;.0&apos;,&apos;&apos;));\n\n            handle = function() {\n                var img = imgDiv.find(&apos;img&apos;);\n                opts.anyTarget &amp;amp;&amp;amp; $.each(opts.anyTarget.split(&apos;,&apos;), function(index, val) {\n                    $(val).html(img.clone());\n                });\n                img.width(opts.width).height(opts.height);\n                opts.callback(img);\n            },\n\n            createImg = function(){\n                imgDiv.html(&apos;&apos;);\n\n                var img = $(&quot;&lt;img /&gt;&quot;);\n                imgDiv.append(img);\n                return img;\n            },\n\n            _this.change(function() {\n\n                if (this.value) {\n                    if (!RegExp(&quot;\\.(&quot; + opts.imgType.join(&quot;|&quot;) + &quot;)$&quot;, &quot;i&quot;).test(this.value.toLowerCase())) {\n                        alert(&quot;图片类型必须是&quot; + opts.imgType.join(&quot;，&quot;) + &quot;中的一种&quot;);\n                        this.value = &quot;&quot;;\n                        return false;\n                    }\n\n                    if (isIE &amp;amp;&amp;amp; version &lt; 10) {\n\n                        if (version == 6) {\n\n                            var image = new Image();\n                            image.onload = function(){\n                                if( (image.fileSize/1024) &gt; opts.maxSize) {\n                                    alert(&apos;图片大小不能超过&apos;+opts.maxSize+&apos;K&apos;);\n                                    return false;\n                                }\n                            }\n                            image.src = &apos;file:///&apos; + this.value;\n\n                            createImg().attr(&apos;src&apos;, image.src);\n                            handle();\n                        }  else {\n\n                            var img = document.selection.createRange().text || $(this).val();\n                            var image = $(&apos;&lt;img /&gt;&apos;)\n                            image.load(function(){\n                                if( (image.fileSize/1024) &gt; opts.maxSize) {\n                                    alert(&apos;图片大小不能超过&apos;+opts.maxSize+&apos;K&apos;);\n                                    return false;\n                                }\n                            });\n                            image.attr(&apos;src&apos;, img);                           \n                            imgDiv.html(&apos;&apos;);           \n\n                            image.css({ filter: &quot;progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=&apos;scale&apos;,src=&apos;&quot;+img+&quot;&apos;)&quot; });\n                            imgDiv.append(image);\n                            setTimeout(handle, 100);                            \n                        }\n                    }\n                    else {\n                        var img;\n                        try{   \n                            var file = null;\n                            var size = 0;\n                            if(this.files &amp;amp;&amp;amp; this.files[0] ){\n                                file = this.files[0]; \n                                size = file.size;\n                            }else if(this.files &amp;amp;&amp;amp; this.files.item(0)) {                                \n                                file = this.files.item(0);   \n                                size = file.fileSize;\n                            } \n\n                            if((size/1024) &gt; opts.maxSize){\n                                alert(&apos;图片大小不能超过&apos;+opts.maxSize+&apos;K&apos;);\n                                return false;\n                            }\n\n                            img = createImg();\n\n                            //Firefox 因安全性问题已无法直接通过input[file].value 获取完整的文件路径\n                            try{\n                                //Firefox7.0 以下                             \n                                img.attr(&apos;src&apos;, file.getAsDataURL());\n                            }catch(e){\n                                //Firefox8.0以上                              \n                                img.attr(&apos;src&apos;, window.URL.createObjectURL(file));\n                            }\n\n                            img.css({ &quot;vertical-align&quot;: &quot;middle&quot; });\n                            setTimeout(handle, 100);\n                        }catch(e){                          \n                            //支持html5的浏览器,比如高版本的firefox、chrome、ie10\n                            if (this.files &amp;amp;&amp;amp; this.files[0]) {                          \n                                if((this.files[0].size/1024) &gt; opts.maxSize){\n                                    alert(&apos;图片大小不能超过&apos;+opts.maxSize+&apos;K&apos;);\n                                    return false;\n                                }\n\n                                var reader = new FileReader(); \n                                reader.onload = function (e) {                                      \n                                    imgDiv.attr(&apos;src&apos;, e.target.result);  \n                                };\n                                reader.readAsDataURL(this.files[0]); \n                                setTimeout(handle, 100);\n                            }  \n                        };\n                    }\n                }\n            });\n        }\n    });\n})(jQuery);\n</code></pre><h3 id=\"参数\"><a href=\"#参数\" class=\"headerlink\" title=\"参数\"></a>参数</h3><ul>\n<li>width: 图片容器宽度；</li>\n<li>height: 图片容器高度；</li>\n<li>imgDiv: 图片预览容器；</li>\n<li>anyTarget: 其他关联容器，多个容器逗号隔开；</li>\n<li>maxSize: 图片大小限制，单位KB；</li>\n<li>imgType: 图片类型限制；</li>\n<li>callback: 预览成功后的回调，参数 img(预览的图片节点，jquery类型)。</li>\n</ul>\n<h3 id=\"实例\"><a href=\"#实例\" class=\"headerlink\" title=\"实例\"></a>实例</h3><pre><code>&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;meta charset=&quot;utf-8&quot;&gt;\n&lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge,chrome=1&quot;&gt;\n&lt;title&gt;图片上传预览&lt;/title&gt;\n&lt;link href=&quot;http://cdn.bootcss.com/jquery-jcrop/0.9.12/css/jquery.Jcrop.css&quot; rel=&quot;stylesheet&quot;&gt;\n&lt;style type=&quot;text/css&quot;&gt;\n    .fl {\n        float: left;\n    }\n    .fr {\n        float: right;\n    }\n    .logo-wrap {\n        overflow: hidden;\n        margin: 30px 0;\n    }\n    .logo-350, .logo-350 img {\n        width: 350px;\n        height: 350px;\n    }\n    .logo-350 {\n        margin-right: 30px;\n    }\n    .logo-200, .logo-200 img {\n        width: 200px;\n        height: 200px;\n    }\n    .logo-200 {\n        margin-bottom: 30px;\n    }\n    .logo-200-wrap {\n        width: 200px;\n    }\n    .logo-100, .logo-100 img {\n        width: 100px;\n        height: 100px;\n    }\n\n    .logo-60, .logo-60 img {\n        width: 60px;\n        height: 60px;\n    }\n\n    .logo-350, .logo-200, .logo-100, .logo-60, .qrcode {\n        border: 1px solid #ddd;\n        overflow: hidden;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;input type=&quot;file&quot; value=&quot;上传文件&quot; id=&quot;file&quot;&gt;  \n    &lt;div class=&quot;logo-wrap&quot;&gt;\n        &lt;div class=&quot;fl logo-350&quot;&gt;&lt;/div&gt;\n        &lt;div class=&quot;fl logo-200-wrap&quot;&gt;\n          &lt;div class=&quot;logo-200&quot;&gt;&lt;div class=&quot;content&quot;&gt;&lt;/div&gt;&lt;/div&gt;\n          &lt;div&gt;\n            &lt;div class=&quot;fl logo-100&quot;&gt;&lt;div class=&quot;content&quot;&gt;&lt;/div&gt;&lt;/div&gt;\n            &lt;div class=&quot;fr logo-60&quot;&gt;&lt;div class=&quot;content&quot;&gt;&lt;/div&gt;&lt;/div&gt;\n          &lt;/div&gt;\n        &lt;/div&gt;\n    &lt;/div&gt;\n&lt;/body&gt;\n&lt;script src=&quot;http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;http://ysdn-wordpress.stor.sinaapp.com/js/jquery.uploadPreview.js&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;http://cdn.bootcss.com/jquery-jcrop/0.9.12/js/jquery.Jcrop.min.js&quot;&gt;&lt;/script&gt;\n&lt;script&gt;  \n//&lt;![CDATA[\n    $(&quot;#file&quot;).uploadPreview({ \n        width: 350,     \n        height: 350, \n        imgDiv: &apos;.logo-350&apos;,    \n        anyTarget: &apos;.logo-200 .content, .logo-100 .content, .logo-60 .content&apos;,\n        maxSize: 1024 * 2,\n        callback: function(el) {\n            var jOption = {\n                setSelect: [75, 75, 275, 275],\n                minSize: [200, 200],\n                onChange: updatePreview,\n                onSelect: updatePreview,\n                aspectRatio: 1\n            };\n\n            var isIE = navigator.appName == &apos;Microsoft Internet Explorer&apos;, \n                brVersion = navigator.appVersion, version;\n            isIE &amp;amp;&amp;amp; (version = brVersion.split(&apos;;&apos;)[1].replace(/MSIE[ ]/g,&apos;&apos;).replace(&apos;.0&apos;,&apos;&apos;));\n\n            if (isIE &amp;amp;&amp;amp; version &lt; 10) {\n                var api = $.Jcrop(el.selector, jOption); \n            } else {\n                el.Jcrop(jOption);\n            }\n\n        }\n    });\n\n    function updatePreview(c) {\n        if (parseInt(c.w) &gt; 0) {\n            $(&apos;.logo-200, .logo-100, .logo-60&apos;).each(function(index, el) {\n                var box = $(el), content = box.find(&apos;.content&apos;), img = content.find(&apos;img&apos;);\n                content.width($(&apos;.logo-350&apos;).outerWidth()).height($(&apos;.logo-350&apos;).outerHeight());\n\n                var rx = box.width() / c.w;\n                var ry = box.height() / c.h;\n\n                img.css({\n                    width: Math.round(rx * 350) + &apos;px&apos;,\n                    height: Math.round(ry * 350) + &apos;px&apos;,\n                    marginLeft: &apos;-&apos; + Math.round(rx * c.x) + &apos;px&apos;,\n                    marginTop: &apos;-&apos; + Math.round(ry * c.y) + &apos;px&apos;\n                });\n            });\n        }\n    }\n//]]&gt;\n&lt;/script&gt;  \n&lt;/html&gt;\n</code></pre>","categories":[],"tags":[{"name":"jquery","path":"api/tags/jquery.json"},{"name":"jquery插件","path":"api/tags/jquery插件.json"}]}